{% extends "base.html" %}
{% block content %}
<h1>{{ g.user.role == 'ADMIN' and 'Usuarios' or 'Mi equipo' }}</h1>

{% if request.args.get('view') == 'create' %}
<section class="section">
  <div class="header-row">
    <h2>Crear usuario</h2>
    <a class="btn btn-outline btn-compact" href="{{ url_for(g.user.role == 'ADMIN' and 'admin_users' or 'jefe_users') }}">Volver</a>
  </div>
  <form method="post" class="form-grid">
    {{ csrf_input() }}
    <label>Nombre
      <input type="text" name="name" required>
    </label>
    <label>Correo
      <input type="email" name="email" required>
    </label>
    <label>Contrase√±a
      <input type="password" name="password" required>
    </label>
    <label>Ciudad
      <input type="text" name="city" required>
    </label>
    <label>Rol
      <select name="role">
        {% for role in roles %}
          <option value="{{ role }}">{{ role }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Estado
      <select name="status">
        {% for status in statuses %}
          <option value="{{ status }}">{{ status }}</option>
        {% endfor %}
      </select>
    </label>
    {% if not jefe_scope %}
    <input type="hidden" name="team_id" value="default">
    <label>Jefe de ventas
      <select name="manager_user_id">
        <option value="">Sin asignar</option>
        {% for manager in managers %}
          <option value="{{ manager.uid }}">{{ manager.name }} ({{ manager.email }})</option>
        {% endfor %}
      </select>
    </label>
    {% endif %}
    <button type="submit" class="btn btn-primary">Crear usuario</button>
  </form>
</section>
{% endif %}

{% if not request.args.get('view') == 'create' %}
<section class="section">
  <div class="header-row">
    <h2>Listado</h2>
    <a class="btn btn-primary btn-compact" href="{{ url_for(g.user.role == 'ADMIN' and 'admin_users' or 'jefe_users', view='create') }}">Crear usuario</a>
  </div>
  <div class="table-shell">
    <table class="table">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Rol</th>
        <th>Estado</th>
        <th>Ciudad</th>
        <th>Jefe</th>
        <th class="table-actions"></th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>{{ user.name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.role }}</td>
        <td>{{ user.status }}</td>
        <td>{{ user.city }}</td>
        <td>
          {% if managers %}
            {% set jefe = (managers | selectattr('uid', 'equalto', user.manager_user_id) | list) %}
            {{ jefe[0].name if jefe else '-' }}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="table-actions">
          {% if g.user.role == 'ADMIN' %}
            <a class="btn btn-outline" href="{{ url_for('admin_user_edit', uid=user.uid) }}">Editar</a>
          {% else %}
            <a class="btn btn-outline" href="{{ url_for('jefe_user_edit', uid=user.uid) }}">Editar</a>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7">Sin usuarios.</td></tr>
      {% endfor %}
    </tbody>
    </table>
  </div>
</section>
{% endif %}
{% endblock %}
